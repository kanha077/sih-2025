<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

  // Supabase client
    const SUPABASE_URL = "https://wraemxcqjycuddhfgjtt.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndyYWVteGNxanljdWRkaGZnanR0Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NzM0NzYxNiwiZXhwIjoyMDcyOTIzNjE2fQ.ziJb9DPVnWQnXwk1yNg-4YPwMi01cjlQx9lp-y72ELk";
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // AI agent config
  const AI_API_URL = "https://your-ai-agent.com/api/chat"; // ⚠️ Replace
  const AI_API_KEY = "YOUR_AI_AGENT_KEY"; // ⚠️ Replace

  const chatForm = document.getElementById("chat-form");
  const messageInput = document.getElementById("message-input");
  const chatMessages = document.getElementById("chat-messages");

  let currentUser = null; // null = anonymous

  // Check session on load
  async function checkSession() {
    const { data } = await supabase.auth.getSession();
    if (data.session) {
      currentUser = data.session.user;
      console.log("Logged in as:", currentUser.email);
    } else {
      console.log("Anonymous user");
    }
  }
  await checkSession();

  async function saveMessage(role, text) {
    if (!currentUser) {
      console.log("Anonymous mode: message not saved to Supabase");
      return;
    }
    const { error } = await supabase.from("chats").insert([
      { role, message: text, user_id: currentUser.id }
    ]);
    if (error) console.error("Error saving message:", error);
  }

  function addMessage(sender, text) {
    const container = document.createElement("div");
    container.classList.add("flex", "flex-col", "w-full");

    const bubble = document.createElement("div");
    bubble.classList.add("max-w-[75%]", "p-3", "rounded-lg", "break-words", "w-fit");

    if (sender === "user") {
      container.classList.add("items-end");
      bubble.classList.add("bg-blue-500", "text-white");
    } else {
      container.classList.add("items-start");
      bubble.classList.add("bg-gray-200", "text-gray-800");
    }

    bubble.textContent = text;
    container.appendChild(bubble);
    chatMessages.appendChild(container);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  async function sendToAI(userInput) {
    try {
      const response = await fetch(AI_API_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${AI_API_KEY}`
        },
        body: JSON.stringify({ message: userInput })
      });
      const data = await response.json();
      return data.reply || "⚠️ No response from AI";
    } catch (err) {
      console.error("AI API Error:", err);
      return "⚠️ Error contacting AI service.";
    }
  }

  chatForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const userInput = messageInput.value.trim();
    if (!userInput) return;

    // Show user message
    addMessage("user", userInput);
    await saveMessage("user", userInput);
    messageInput.value = "";

    // Typing placeholder
    addMessage("assistant", "Typing...");

    // AI response
    const botReply = await sendToAI(userInput);

    // Remove "Typing..."
    chatMessages.lastChild.remove();

    // Show AI response
    addMessage("assistant", botReply);
    await saveMessage("assistant", botReply);
  });
</script>
