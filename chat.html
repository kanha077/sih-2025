<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chat - Ananda</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; display: flex; height: 100vh; }
    #user-list { width: 25%; border-right: 1px solid #ccc; overflow-y: auto; padding: 10px; }
    #chat-area { flex: 1; display: flex; flex-direction: column; }
    #messages { flex: 1; padding: 10px; overflow-y: auto; }
    #message-form { display: flex; border-top: 1px solid #ccc; }
    #message-input { flex: 1; padding: 10px; border: none; }
    #send-btn { padding: 10px; border: none; background: #4caf50; color: white; cursor: pointer; }
    .message { margin: 5px 0; }
    .me { text-align: right; color: blue; }
    .other { text-align: left; color: green; }
    .user-item { cursor: pointer; padding: 8px; border-bottom: 1px solid #eee; }
    .user-item:hover { background: #f0f0f0; }
  </style>
</head>
<body>
  <div id="user-list"></div>
  <div id="chat-area" style="display:none;">
    <h3 id="chat-with-name"></h3>
    <div id="messages"></div>
    <form id="message-form">
      <input id="message-input" type="text" placeholder="Type a message..." autocomplete="off" />
      <button id="send-btn" type="submit">Send</button>
    </form>
  </div>

  <script type="module">
    import { supabase } from './supabaseClient.js';

    let currentUser = null;
    let activeChatId = null;
    let activeUserId = null;
    let messageChannel = null;

    const userListEl = document.getElementById('user-list');
    const chatAreaEl = document.getElementById('chat-area');
    const messagesEl = document.getElementById('messages');

    // ✅ Load current user
    async function loadUser() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        alert("Please log in first.");
        return window.location.href = "login.html";
      }
      currentUser = user;
      loadContacts();
    }

    // ✅ Load contacts (based on role)
    async function loadContacts() {
      const role = currentUser.user_metadata.role;

      if (role === "student") {
        const { data: convos } = await supabase
          .from('conversations')
          .select('counselor_id')
          .eq('student_id', currentUser.id);

        if (convos?.length) {
          const ids = convos.map(c => c.counselor_id);
          const { data: counselors } = await supabase
            .from('profiles')
            .select('id, full_name')
            .in('id', ids);
          displayUserList(counselors);
        }
      } else if (role === "counselor") {
        const { data: convos } = await supabase
          .from('conversations')
          .select('student_id')
          .eq('counselor_id', currentUser.id);

        if (convos?.length) {
          const ids = convos.map(c => c.student_id);
          const { data: students } = await supabase
            .from('profiles')
            .select('id, full_name')
            .in('id', ids);
          displayUserList(students);
        }
      }
    }

    function displayUserList(users) {
      userListEl.innerHTML = "";
      users.forEach(u => {
        const div = document.createElement("div");
        div.className = "user-item";
        div.textContent = u.full_name || "Unnamed";
        div.onclick = () => openChatWith(u.id, u.full_name);
        userListEl.appendChild(div);
      });
    }

    // ✅ Open chat with a user
    async function openChatWith(otherUserId, otherUserName) {
      const role = currentUser.user_metadata.role;
      const studentId = role === "student" ? currentUser.id : otherUserId;
      const counselorId = role === "counselor" ? currentUser.id : otherUserId;

      // check or create conversation
      let { data: convo, error } = await supabase
        .from('conversations')
        .select('id')
        .eq('student_id', studentId)
        .eq('counselor_id', counselorId)
        .single();

      if (!convo) {
        const { data: newConvo, error: insertError } = await supabase
          .from('conversations')
          .insert({ student_id: studentId, counselor_id: counselorId })
          .select('id')
          .single();
        convo = newConvo;
      }

      activeChatId = convo.id;
      activeUserId = otherUserId;

      document.getElementById('chat-with-name').textContent = "Chat with " + otherUserName;
      chatAreaEl.style.display = "flex";
      messagesEl.innerHTML = "";

      // load old messages
      const { data: messages } = await supabase
        .from('msg')
        .select('*')
        .eq('conversation_id', activeChatId)
        .order('created_at');

      if (messages) messages.forEach(m => appendMessage(m));

      // unsubscribe from old channel
      if (messageChannel) {
        supabase.removeChannel(messageChannel);
      }

      // subscribe to realtime messages
      messageChannel = supabase.channel('chat-' + activeChatId)
        .on('postgres_changes', {
          event: 'INSERT',
          schema: 'public',
          table: 'msg',
          filter: `conversation_id=eq.${activeChatId}`
        }, payload => {
          appendMessage(payload.new);
        })
        .subscribe();
    }

    // ✅ Append message
    function appendMessage(msg) {
      const div = document.createElement("div");
      div.className = "message " + (msg.sender_id === currentUser.id ? "me" : "other");
      div.textContent = msg.content;
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // ✅ Send message
    document.getElementById('message-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const input = document.getElementById('message-input');
      const content = input.value.trim();
      if (!content || !activeChatId) return;

      await supabase.from('msg').insert({
        conversation_id: activeChatId,
        sender_id: currentUser.id,
        content: content
      });

      input.value = "";
    });

    loadUser();
  </script>
</body>
</html>
