<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Screening Test - Ananda</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
        <link rel="icon" type="image/png" href="favicon.png">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .btn-primary {
            background-color: #4CAF50;
            color: white;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #45a049;
            transform: translateY(-2px);
        }
        .btn-secondary {
            background-color: #ffffff;
            color: #333;
            border: 1px solid #d1d5db;
            transition: all 0.3s ease;
        }
        .btn-secondary:hover {
             background-color: #f9fafb;
        }
        .question-group { margin-bottom: 2rem; padding-bottom: 2rem; border-bottom: 1px solid #e5e7eb; }
        .question-group:last-of-type { border-bottom: none; }
        .question-text { font-weight: 600; margin-bottom: 1rem; color: #1f2937; font-size: 1.1rem; }
        .options-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; }
        .option-label { display: block; padding: 1rem; border: 1px solid #d1d5db; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s ease; text-align: center; }
        .option-label:hover { background-color: #f9fafb; }
        .option-input:checked + .option-label { background-color: #4CAF50; color: white; border-color: #4CAF50; font-weight: 500; }
        .option-input { display: none; }
        .result-card { border-left-width: 5px; padding: 1.5rem; border-radius: 8px; background-color: #f9fafb; }
        .result-card h3 { font-size: 1.25rem; font-weight: 700; }
        .result-card p { margin-top: 0.5rem; line-height: 1.6; }
    </style>
</head>
<body class="antialiased">
    <header class="bg-white/80 backdrop-blur-md sticky top-0 z-50 shadow-sm">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="index.html" class="flex items-center gap-3">
                <img src="https://ik.imagekit.io/riqdruvej/WhatsApp%20Image%202025-09-11%20at%2021.07.16_ad53dd02.jpg?updatedAt=1757704066278" alt="Ananda Logo" class="h-8 w-auto">
                <span class="text-xl font-bold text-gray-800">ANANDA</span>
            </a>
            <div>
                <a href="student.html" class="btn-secondary font-semibold px-6 py-2 rounded-full">Back to Dashboard</a>
            </div>
        </nav>
    </header>

    <main class="container mx-auto px-6 py-12">
        <div class="bg-white p-8 rounded-2xl shadow-lg max-w-4xl mx-auto">
            <div id="screeningIntro">
                <h1 class="text-3xl font-bold mb-4 text-center">Mental Health Screening Test</h1>
                <p class="max-w-3xl mx-auto mb-8 text-center text-gray-600">This confidential assessment, consisting of the PHQ-9 (for depression) and GAD-7 (for anxiety), will help you understand your current mental health status. The questions will ask about how often you have been bothered by various problems over the last 2 weeks.</p>
                <div class="text-center">
                   <button class="btn-primary text-lg font-semibold px-8 py-3 rounded-full" onclick="startScreeningTest()">Begin Assessment</button>
                </div>
            </div>
            <form id="screeningTestContainer" style="display: none;"></form>
            <div id="screeningResultContainer" style="display: none;"></div>
        </div>
    </main>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = "https://wraemxcqjycuddhfgjtt.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndyYWVteGNxanljdWRkaGZnanR0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNDc2MTYsImV4cCI6MjA3MjkyMzYxNn0.QyBb8idQcPmWJUQ7sMorfmnGp7fZU6DpuA1U79KpgCQ";
        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', async () => {
            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) {
                window.location.href = window.location.origin + "/login.html";
            } else {
                currentUser = session.user;
                const { data: profile } = await _supabase.from('profiles').select('screening_completed').eq('id', currentUser.id).single();
                if (profile && profile.screening_completed) {
                    showScreeningResults();
                }
            }
        });

        async function startScreeningTest() {
            document.getElementById('screeningIntro').style.display = 'none';
            const container = document.getElementById('screeningTestContainer');
            container.style.display = 'block';
            container.innerHTML = '<p class="text-center">Loading questions...</p>';

            const { data: questions, error } = await _supabase.from('screening_questions').select('*').order('sort_order');
            if (error) {
                container.innerHTML = '<p class="text-center text-red-600">Could not load questions. Please try again later.</p>';
                return;
            }

            const options = [
                { text: "Not at all", value: 0 }, { text: "Several days", value: 1 },
                { text: "More than half the days", value: 2 }, { text: "Nearly every day", value: 3 }
            ];

            let questionsHtml = `<h2 class="text-2xl font-bold mb-8 text-center">Over the last 2 weeks, how often have you been bothered by...</h2>`;
            questions.forEach((q, index) => {
                questionsHtml += `
                    <div class="question-group" data-question-id="${q.id}" data-type="${q.questionnaire_type}">
                        <p class="question-text">${index + 1}. ${q.question_text}</p>
                        <div class="options-grid">`;
                options.forEach(opt => {
                    questionsHtml += `
                        <div>
                            <input type="radio" id="q${q.id}_opt${opt.value}" name="q_${q.id}" value="${opt.value}" class="option-input" required>
                            <label for="q${q.id}_opt${opt.value}" class="option-label">${opt.text}</label>
                        </div>`;
                });
                questionsHtml += `</div></div>`;
            });
            
            questionsHtml += `<div class="text-center"><button type="submit" class="btn-primary mt-6 text-lg font-semibold px-8 py-3 rounded-full">Submit Answers</button></div>`;
            container.innerHTML = questionsHtml;
            container.addEventListener('submit', submitScreeningTest);
        }

        async function submitScreeningTest(event) {
            event.preventDefault();
            const questionGroups = document.querySelectorAll('.question-group');
            if (Array.from(questionGroups).some(g => !g.querySelector('input[type="radio"]:checked'))) {
                alert('Please answer all questions before submitting.');
                return;
            }

            const button = event.target.querySelector('button');
            button.disabled = true;
            button.textContent = 'Submitting...';

            const responsesToSave = [];
            let phq9Score = 0, gad7Score = 0;

            questionGroups.forEach(group => {
                const selectedOption = group.querySelector('input[type="radio"]:checked');
                const responseValue = parseInt(selectedOption.value);
                responsesToSave.push({ user_id: currentUser.id, question_id: group.dataset.questionId, response_value: responseValue });
                if (group.dataset.type === 'PHQ-9') phq9Score += responseValue;
                if (group.dataset.type === 'GAD-7') gad7Score += responseValue;
            });
            
            const phq9Result = getInterpretation('PHQ-9', phq9Score);
            const gad7Result = getInterpretation('GAD-7', gad7Score);

            const scoresToSave = [
                { user_id: currentUser.id, questionnaire_type: 'PHQ-9', score: phq9Score, severity: phq9Result.severity },
                { user_id: currentUser.id, questionnaire_type: 'GAD-7', score: gad7Score, severity: gad7Result.severity }
            ];

            const { error: responsesError } = await _supabase.from('screening_responses').insert(responsesToSave);
            const { error: scoresError } = await _supabase.from('screening_scores').insert(scoresToSave);
            const { error: profileError } = await _supabase.from('profiles').update({ screening_completed: true }).eq('id', currentUser.id);

            if (responsesError || scoresError || profileError) {
                alert('An error occurred while saving your results. Please try again.');
                button.disabled = false;
                button.textContent = 'Submit Answers';
                return;
            }

            // --- START OF NEW CODE ---
            // Prepare data payload for Google Sheets
            const sheetData = {
                userId: currentUser.id,
                userEmail: currentUser.email,
                phq9Score: phq9Score,
                phq9Severity: phq9Result.severity,
                gad7Score: gad7Score,
                gad7Severity: gad7Result.severity
            };

            // Send data to Google Sheet (this happens in the background)
           // New function to send data to your Google Sheet Web App
async function sendDataToGoogleSheet(data) {
    // !!! IMPORTANT !!! Paste your Web App URL from Step 1 here
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzlufWsTzdDwpGp8UUJDYkt1sZ26-Lh80qnTd-N0nHnuNzJQt6V7gVYHjEdbECzBJvZpg/exec';

    try {
        await fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors', // Important for sending data from a browser to a Google Script
            cache: 'no-cache',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
    } catch (error) {
        console.error('Error sending data to Google Sheet:', error);
        // You can optionally add logic here to handle the error,
        // but the main functionality of saving to Supabase is already complete.
    }
}
            // --- END OF NEW CODE ---

            alert('Your assessment has been submitted successfully.');
            await showScreeningResults();
        }

        async function showScreeningResults() {
            document.getElementById('screeningIntro').style.display = 'none';
            document.getElementById('screeningTestContainer').style.display = 'none';
            const resultContainer = document.getElementById('screeningResultContainer');
            resultContainer.style.display = 'block';
            resultContainer.innerHTML = '<p class="text-center">Loading your results...</p>';

            const { data, error } = await _supabase.from('screening_scores').select('questionnaire_type, score, severity').eq('user_id', currentUser.id).order('completed_at', { ascending: false }).limit(2);
            if (error || !data || data.length < 2) {
                resultContainer.innerHTML = '<p class="text-center text-red-600">Could not load results. Please complete the assessment first.</p>';
                return;
            }
            
            const phq9Data = data.find(r => r.questionnaire_type === 'PHQ-9');
            const gad7Data = data.find(r => r.questionnaire_type === 'GAD-7');
            const phq9Result = getInterpretation('PHQ-9', phq9Data.score);
            const gad7Result = getInterpretation('GAD-7', gad7Data.score);

            resultContainer.innerHTML = `
                <h2 class="text-2xl font-bold mb-6 text-center">Your Assessment Results</h2>
                <div class="space-y-6 max-w-3xl mx-auto">
                    <div class="result-card" style="border-color: ${phq9Result.color};">
                        <h3 class="font-bold">PHQ-9 (Depression) Score: ${phq9Data.score}</h3>
                        <p><strong>Severity:</strong> ${phq9Data.severity}</p>
                        <p>${phq9Result.recommendation}</p>
                    </div>
                     <div class="result-card" style="border-color: ${gad7Result.color};">
                        <h3 class="font-bold">GAD-7 (Anxiety) Score: ${gad7Data.score}</h3>
                        <p><strong>Severity:</strong> ${gad7Data.severity}</p>
                        <p>${gad7Result.recommendation}</p>
                    </div>
                </div>
                <p class="mt-8 text-sm text-gray-500 text-center"><strong>Disclaimer:</strong> This screening is a tool to help you understand your mental state, not a diagnosis. Please consult a healthcare professional for an accurate diagnosis and treatment plan.</p>
                <div class="text-center mt-6"><button class="btn-secondary font-semibold px-6 py-2 rounded-full" onclick="retakeTest()">Retake Assessment</button></div>
            `;
        }
        
        function retakeTest() {
            if(confirm("Are you sure you want to retake the assessment? Your previous responses and scores will be deleted.")) {
                // For simplicity, we just restart the test. For a production app, you might archive old results.
                document.getElementById('screeningResultContainer').style.display = 'none';
                startScreeningTest();
            }
        }

        function getInterpretation(type, score) {
            const levels = {
                'PHQ-9': [ { max: 4, severity: 'Minimal', color: '#2ecc71', rec: 'Your symptoms are minimal. Continue monitoring your mood.' }, { max: 9, severity: 'Mild', color: '#f1c40f', rec: 'You may be experiencing mild depression. Lifestyle changes and self-help strategies may be beneficial.' }, { max: 14, severity: 'Moderate', color: '#e67e22', rec: 'You have symptoms of moderate depression. It is recommended to speak with a doctor or mental health professional.' }, { max: 19, severity: 'Moderately Severe', color: '#d35400', rec: 'Your symptoms suggest moderately severe depression. Professional help is strongly recommended.' }, { max: 27, severity: 'Severe', color: '#c0392b', rec: 'Your symptoms are severe. Please seek professional help immediately.' } ],
                'GAD-7': [ { max: 4, severity: 'Minimal', color: '#2ecc71', rec: 'Your anxiety symptoms are minimal.' }, { max: 9, severity: 'Mild', color: '#f1c40f', rec: 'You may be experiencing mild anxiety. Consider self-help and relaxation techniques.' }, { max: 14, severity: 'Moderate', color: '#e67e22', rec: 'Your symptoms suggest moderate anxiety. Speaking with a professional could be helpful.' }, { max: 21, severity: 'Severe', color: '#c0392b', rec: 'You may have severe anxiety. It is highly recommended to consult with a mental health professional.' } ]
            };
            return levels[type].find(level => score <= level.max);
        }

        // --- NEW FUNCTION TO SEND DATA TO GOOGLE SHEETS ---
        async function sendDataToGoogleSheet(data) {
            // !!! IMPORTANT !!! Paste your Web App URL from Step 1 here
            const GOOGLE_SCRIPT_URL = 'YOUR_WEB_APP_URL_HERE';

            try {
                await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Important for sending data from a browser to a Google Script
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
            } catch (error) {
                console.error('Error sending data to Google Sheet:', error);
                // You can optionally add logic here to handle the error,
                // but the main functionality of saving to Supabase is already complete.
            }
        }
    </script>
</body>
</html>