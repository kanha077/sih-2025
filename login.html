<script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    const SUPABASE_URL = 'https://wraemxcqjycuddhfgjtt.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndyYWVteGNxanljdWRkaGZnanR0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNDc2MTYsImV4cCI6MjA3MjkyMzYxNn0.QyBb8idQcPmWJUQ7sMorfmnGp7fZU6DpuA1U79KpgCQ';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    supabase.auth.onAuthStateChange(async (event, session) => {
        if (event === "SIGNED_IN" && session) {
            const user = session.user;

            // --- 1. Check role from app_metadata (preferred way) ---
            let role = user.app_metadata?.role;

            // --- 2. Fallback: check from profiles table ---
            if (!role) {
                const { data: profile, error } = await supabase
                    .from('profiles')
                    .select('phone, role')
                    .eq('id', user.id)
                    .single();

                if (error && error.code !== 'PGRST116') {
                    console.error('Error fetching profile:', error);
                }

                role = profile?.role || "user";

                // If user profile incomplete, redirect to complete profile page
                if (!profile || !profile.phone) {
                    window.location.href = window.location.origin + '/complete-profile.html';
                    return;
                }
            }

            // --- 3. Redirect based on role ---
            if (role === "admin") {
                window.location.href = window.location.origin + '/admin.html';
            } else {
                window.location.href = window.location.origin + '/user.html';
            }
        }
    });

    const loginForm = document.getElementById('loginForm');
    loginForm.addEventListener('submit', login);

    function showModal(title, message) {
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalMessage').innerText = message;
        document.getElementById('modal').classList.remove('hidden');
        document.getElementById('modal').classList.add('flex');
    }

    function closeModal() {
        document.getElementById('modal').classList.add('hidden');
    }
    window.closeModal = closeModal;

    async function login(e) {
        e.preventDefault();
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        const loginBtn = document.getElementById("loginBtn");
        loginBtn.disabled = true;
        loginBtn.innerText = "Logging in...";

        const { error } = await supabase.auth.signInWithPassword({ email, password });

        if (error) {
            showModal("Login Failed", error.message);
            loginBtn.disabled = false;
            loginBtn.innerText = "Log In";
        }
    }

    async function signInWithGoogle() {
        const { error } = await supabase.auth.signInWithOAuth({ 
            provider: 'google',
            options: {
                redirectTo: window.location.origin + '/login.html'
            }
        });
        if (error) {
            showModal("Google Sign-in Failed", error.message);
        }
    }
    window.signInWithGoogle = signInWithGoogle;
</script>
